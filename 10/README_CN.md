# Advent of Code 2025 — Day 10（第二部分）求解器说明（中文）

本文件精确描述第二部分（P2）求解器的输入约定、数学建模、核心算法、诊断输出、使用方法与常见问题。实现采用有理数（`big.Rat`）的高斯消元与对自由变量的有界最佳优先搜索，能在小位宽（例如 m ≤ 6）与合理按钮数量下快速得到最小按压次数。

## 一、问题定义

- 输入
  - 目标灯状态 `result`：一个位模式（`[...]`），表示最终各灯的高低状态（奇偶）。
  - 按钮列表 `instructions`：每个按钮作用的位索引集合（形如 `(i,j,...)`），按统一方向解释。
  - 位计数目标 `counter`：每个位被“影响”的总次数（形如 `{c0,c1,...}`），是精确计数而非仅奇偶。
- 输出
  - 每个按钮的按压次数 `x_i ≥ 0`（整数），满足：
    1) 对每个位 `j`：Σ_i A[i,j]·x_i = counter[j]，其中 A[i,j] ∈ {0,1} 表示按钮 i 是否影响位 j。
    2) 最终状态奇偶匹配 `result`（可由计数奇偶与按钮覆盖关系推导）。
    3) 总按压次数 Σ_i x_i 最小。

这本质是一个线性方程的整数非负解问题，并附带最小化目标。

## 二、位方向（Orientation）与解析约定（务必统一）

为避免索引混乱，P2 全面采用“从左到右（LTR）”的位方向约定：
- `result`：`[...]` 内的最左字符对应 bit 0，依次向右递增。
- `instructions`：形如 `(0,2,3)`，这些索引按 LTR 解释，即与上述 bit 位置一致。
- `counter`：`{c0,c1,...}` 中第一个数对应 bit 0（最左），依次向右。

> 坑: P1 采用 LSB-right（最低位在右侧）的解析方式；P2 必须将所有输入统一转换为 LTR 后再建模。

## 三、诊断输出（辅助定位方向与可行性）

在求解前会打印三项诊断（均为 LTR 对齐）：
- `resultBits(LTR)`：结果位的奇偶向量（bit j 为 0/1）。
- `counterParity(LTR)`：计数的奇偶向量（`counter[j] % 2`）。
- `instructions(LTR)`：每个按钮的覆盖位索引列表。

建议在调试阶段保留这些输出，确认：
- 位方向统一；
- 奇偶在需要时是否一致（见下一节）。

## 四、数学与算法

### 4.1 高斯消元（有理数）

- 构建矩阵 `grid`（行数 rows = 位数 m，列数 columns = 按钮数 n）：
  - `grid[r][c] = 1` 表示按钮 c 影响位 r，否则为 0。
- 构建右端向量 `rhs`：`rhs[r] = counter[r]`（以 `big.Rat` 存储，保持精确）。
- 执行有理数高斯消元（允许行/列交换）：
  - 选择非零主元，归一化为 1。
  - 对其他行消元，使该列仅主元所在行为 1，其余为 0。
- 跟踪列交换的排列 `colPerm`，保证后续针对按钮列的操作与当前列顺序一致。
- 消元完成后：
  - 将全零的尾行截断；若这部分 `rhs` 非零，说明“计数与覆盖不相容”（数学上不可解）。
  - 前 `rows'` 列为主变量（由系统确定），后 `columns - rows'` 列为自由变量。

### 4.2 自由变量的有界搜索（最佳优先）

对“尾部列”（自由变量）进行有界枚举与搜索：
- 对每个自由变量列 `c`，计算：
  - 最大按压上界 `max_presses[c] = min(counter[j])`（遍历按钮 c 覆盖的所有位 j）。这是合理上限，避免任何位的计数超过目标。
  - 单次按压的净影响（有理数）`diff[c] = 1 - Σ_r grid[r][c]`。
    - 含义：自由变量 +1 会使主变量的需求按表达式下降 `Σ grid[r][c]`；净效果是“加 1 减 去这部分”，有时为负值，意味着“按它能减少总按压”。
- 用混合进制把自由变量向量编码为一个整数 `at`（便于在优先队列中记录状态）：
  - 基数 base[i] = `max_presses[i] + 1`；
  - 因子 `factor[i]` 为之前所有基数的乘积。
- 初始状态（启发式）：
  - 若 `diff[i] < 0`（按它能减少总按压），将自由变量 i 设为其最大值；否则设为 0。
- 搜索过程（最佳优先）：
  - 优先队列按累计“added presses”（有理数）从小到大展开。
  - 从当前 `at` 解码出自由变量向量 `trailing`，代入表达式求主变量解：
    - `main[r] = rhs[r] - Σ_i grid[r][rows'+i] * trailing[i]`（有理数）。
  - 若所有 `main[r]` 非负且为整数（分母为 1），则得到一个可行解；总按压为 `Σ main + Σ trailing`，最小值即答案。
  - 否则生成邻居：
    - 当 `diff[i] < 0` 且 `trailing[i] > 0`，尝试减少该自由变量（更优方向）；
    - 若 `trailing[i] < max_presses[i]`，也可尝试增加。
  - 用 visited 集合避免重复状态。

该搜索在位宽小、自由变量上界有限时收敛非常快。

## 五 示例（完整推导与矩阵视图）

以 `[.##.] (3) (1,3) (2) (2,3) (0,2) (0,1) {3,5,4,7}` 为例，按 LTR 位方向（bit0 为最左）建立变量并推导。

- 位（从左到右）：bit0, bit1, bit2, bit3
- 按钮与变量定义（次数均为非负整数）：
  - `x_f` 对应按钮 `(3)`（仅影响 bit3）
  - `x_c` 对应按钮 `(1,3)`（影响 bit1 与 bit3）
  - `x_d` 对应按钮 `(2)`（仅影响 bit2）
  - `x_e` 对应按钮 `(2,3)`（影响 bit2 与 bit3）
  - `x_a` 对应按钮 `(0,2)`（影响 bit0 与 bit2）
  - `x_b` 对应按钮 `(0,1)`（影响 bit0 与 bit1）

- 计数目标 `counter = {3,5,4,7}`（LTR）给出每个位的方程：
  - bit0: 被 `(0,2)` 与 `(0,1)` 影响 → `x_a + x_b = 3`
  - bit1: 被 `(1,3)` 与 `(0,1)` 影响 → `x_c + x_b = 5`
  - bit2: 被 `(2)`、`(2,3)`、`(0,2)` 影响 → `x_d + x_e + x_a = 4`
  - bit3: 被 `(3)`、`(1,3)`、`(2,3)` 影响 → `x_f + x_c + x_e = 7`

- 矩阵视图（A 为覆盖矩阵，行对应位，列对应按钮变量 `[x_f, x_c, x_d, x_e, x_a, x_b]`）：
  ```
  A =
  [ 0 0 0 0 1 1 ]   = bit0  覆盖于 (0,2),(0,1)
  [ 0 1 0 0 0 1 ]   = bit1  覆盖于 (1,3),(0,1)
  [ 0 0 1 1 1 0 ]   = bit2  覆盖于 (2),(2,3),(0,2)
  [ 1 1 0 1 0 0 ]   = bit3  覆盖于 (3),(1,3),(2,3)
  ```

- 方程组与目标：
  ```
  x_a + x_b = 3
  x_c + x_b = 5
  x_d + x_e + x_a = 4
  x_f + x_c + x_e = 7
  目标：最小化 T = x_a + x_b + x_c + x_d + x_e + x_f
  所有 x_* ≥ 0 且为整数
  ```

- 奇偶说明（可选校验）：若 `result = [.##.]`，其 LTR 奇偶向量为 `[0,1,1,0]`。计数的奇偶向量为 `[3%2, 5%2, 4%2, 7%2] = [1,1,0,1]`。严格“计数即最终奇偶”的语义下此处并不一致；但在当前实现中，采用线性方程精确计数与自由变量优化的组合来寻找满足方程且总按压最小的整数解。实践运行得到的最优解总按压为 `10`。

- 一个可行的解构造示意（仅示例）：
  - 由 bit0 方程可从 `(x_a, x_b)` 的非负整数解对中选取；
  - 将其代入 bit1、bit2、bit3 方程，逐步解出剩余变量；
  - 求得所有变量非负且整数时，计算总按压 `T`，取最小的一个即为答案。
  - 实际求解通过高斯消元将部分变量作为主变量，剩余作为自由变量，并在自由变量的有限范围内做最佳优先搜索，最终得到 `T = 10`。

> 注：上例的奇偶不一致体现了“输入规范与语义”的重要性。若输入保证计数与结果奇偶一致，则严格校验可在消元前快速判定可行性；当前实现为兼容不同数据约定，可暂时关闭严格校验，但仍以“线性方程 + 最优搜索”的方式输出最小总按压。

## 六、结论

该 P2 求解器通过统一 LTR 位方向、精确的有理数消元以及对自由变量的有界最佳优先搜索，能够在 AoC 的规模下快速返回满足“精确计数 + 最小总按压”的解。调试期间请关注诊断输出，确保输入方向与奇偶一致；一旦稳定，即可关闭多余日志并（可选）启用奇偶快速校验，使整体流程更稳健高效。
